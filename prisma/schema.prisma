datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============== ENUMS ==============

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
}

enum DealStage {
  NEW
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  LEAD
  CUSTOMER
}

// ============== MODELS ==============

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  password       String
  firstName      String
  lastName       String
  role           Role      @default(USER)
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  refreshToken   String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? // Soft delete

  deals      Deal[]
  activities Activity[]

  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

model Company {
  id        String    @id @default(uuid())
  name      String
  industry  String?
  website   String?
  address   String?
  phone     String?
  notes     String?   @db.Text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  contacts Contact[]
  deals    Deal[]

  @@index([name])
  @@index([deletedAt])
  @@map("companies")
}

model Contact {
  id        String        @id @default(uuid())
  firstName String
  lastName  String
  email     String        @unique
  phone     String?
  title     String? // Job title
  status    ContactStatus @default(LEAD)
  companyId String?
  notes     String?       @db.Text
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime? // Soft delete

  company    Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  deals      Deal[]
  activities Activity[]

  @@index([email])
  @@index([companyId])
  @@index([status])
  @@index([deletedAt])
  @@map("contacts")
}

model Deal {
  id                String    @id @default(uuid())
  title             String
  amount            Decimal   @db.Decimal(12, 2)
  stage             DealStage @default(NEW)
  probability       Int       @default(0) // 0-100%
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  ownerId           String
  contactId         String?
  companyId         String?
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete

  owner      User       @relation(fields: [ownerId], references: [id])
  contact    Contact?   @relation(fields: [contactId], references: [id], onDelete: SetNull)
  company    Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  activities Activity[]

  @@index([ownerId])
  @@index([stage])
  @@index([companyId])
  @@index([deletedAt])
  @@map("deals")
}

model Activity {
  id          String       @id @default(uuid())
  type        ActivityType
  subject     String
  description String?      @db.Text
  dueDate     DateTime?
  completedAt DateTime?
  userId      String
  contactId   String?
  dealId      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  deal    Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([contactId])
  @@index([dealId])
  @@index([dueDate])
  @@map("activities")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String // CREATE, UPDATE, DELETE
  entity    String // users, contacts, deals, etc.
  entityId  String
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
